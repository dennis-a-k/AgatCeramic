document.addEventListener("DOMContentLoaded",function(){E(),T(),g()});function E(){document.querySelectorAll(".add-cart").forEach(c=>{c.addEventListener("click",function(){var a;const t=this.dataset.productId,r=((a=this.closest(".pro-details-quality"))==null?void 0:a.querySelector(".cart-plus-minus-box"))||document.querySelector(".cart-plus-minus-box"),d=r?r.value:1;x(t,d)})}),document.querySelectorAll(".cart-plus-minus-box").forEach(c=>{c.closest(".table-content")&&c.addEventListener("change",function(){const t=this.closest("tr").dataset.productId;l(t,this.value)})}),document.querySelectorAll(".product-remove a").forEach(c=>{c.addEventListener("click",function(t){t.preventDefault();const r=this.closest("tr").dataset.productId;m(r)})})}function T(){document.querySelectorAll(".cart-plus-minus").forEach(n=>{const e=n.querySelector(".cart-plus-minus-box");if(!e)return;const c=document.createElement("div"),t=document.createElement("div");c.className="dec qtybutton",c.textContent="-",t.className="inc qtybutton",t.textContent="+",e.parentNode.insertBefore(c,e),e.parentNode.appendChild(t),c.addEventListener("click",()=>i(e,-1)),t.addEventListener("click",()=>i(e,1))})}function i(o,n){let e=parseInt(o.value);if(e=Math.max(1,e+n),o.value=e,o.closest(".table-content")){const c=o.closest("tr").dataset.productId;l(c,e)}}function x(o,n){fetch("/cart/add",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({product_id:o,quantity:n})}).then(e=>e.json()).then(e=>{f(e.message),p(e.cart_count),u()}).catch(e=>console.error("Ошибка:",e))}function l(o,n){fetch("/cart/update",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({product_id:o,quantity:n})}).then(e=>e.json()).then(e=>{y(e.total),L(o,n),u()}).catch(e=>console.error("Ошибка:",e))}function m(o){fetch("/cart/remove",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({product_id:o})}).then(n=>n.json()).then(n=>{const e=document.querySelector(`tr[data-product-id="${o}"]`);e&&e.remove(),y(n.total),p(n.cart_count),f(n.message),u(),window.location.pathname==="/cart"&&n.cart_count===0&&window.location.reload()}).catch(n=>console.error("Ошибка:",n))}function f(o){const n=document.createElement("div");n.className="cart-notification",n.textContent=o,document.body.appendChild(n),setTimeout(()=>{n.remove()},3e3)}function p(o){const n=document.querySelector(".product-subtotal"),e=document.querySelectorAll(".header-action-btn-cart div, .header-action-btn-cart");n&&(n.textContent=o),e.forEach(c=>{let t=c.querySelector(".header-action-num");if(o>0){if(!t)if(t=document.createElement("span"),t.className="header-action-num",c.tagName.toLowerCase()==="a"){const r=c.querySelector(".pe-7s-cart");r&&r.after(t)}else c.appendChild(t);t.textContent=o.toString()}else t&&t.remove()})}function y(o){const n=document.querySelector(".cart-total");n&&(n.textContent=`${o} ₽`)}function L(o,n){const e=document.querySelector(`tr[data-product-id="${o}"]`);if(e){const c=e.querySelector(".product-subtotal"),t=parseFloat(e.querySelector(".product-price-cart .amount").textContent);if(c&&!isNaN(t)){const r=t*n;c.textContent=`${r.toFixed(1)} ₽`}}}function g(){const o=document.querySelector('a[href="#offcanvas-cart"]');o&&o.addEventListener("click",function(n){u()}),v()}function u(){fetch("/cart/offcanvas",{headers:{"X-Requested-With":"XMLHttpRequest"}}).then(o=>o.text()).then(o=>{const c=new DOMParser().parseFromString(o,"text/html").querySelector("#offcanvas-cart");if(c){const t=document.querySelector("#offcanvas-cart");t.innerHTML=c.innerHTML,v()}}).catch(o=>{console.error("Ошибка обновления корзины:",o)})}function v(){document.querySelectorAll("#offcanvas-cart .remove").forEach(e=>{e.replaceWith(e.cloneNode(!0));const c=document.querySelector(`#offcanvas-cart .remove[data-product-id="${e.dataset.productId}"]`);c&&c.addEventListener("click",function(t){t.preventDefault();const r=this.dataset.productId;m(r)})});const n=document.querySelector("#offcanvas-cart .offcanvas-close");n&&(n.replaceWith(n.cloneNode(!0)),document.querySelector("#offcanvas-cart .offcanvas-close").addEventListener("click",function(c){c.preventDefault(),document.body.classList.remove("offcanvas-open"),document.querySelector("#offcanvas-cart").classList.remove("offcanvas-open"),document.querySelector(".offcanvas-overlay").style.display="none",document.querySelector(".offcanvas-overlay").classList.remove("active")}))}document.addEventListener("DOMContentLoaded",function(){const o=window.location.origin;document.querySelectorAll(".quickview").forEach(e=>{e.addEventListener("click",function(){document.querySelector(".cart-plus-minus-box").value=1;const c=this.getAttribute("data-id");document.querySelector("#modalProduct .modal-body h2").innerText="Загрузка...",document.querySelector("#modalProduct .modal-body .new-price").innerText="",document.querySelector("#modalProduct .modal-body .swiper-container .swiper-wrapper").innerHTML="",fetch(`${o}/api/product/${c}`).then(t=>{if(!t.ok)throw new Error("Ошибка загрузки данных");return t.json()}).then(t=>{const r=t.title||"---",d=t.price||"---",a=t.sku||"---",h=t.unit==="шт"?"<span>шт.</span>":"<span>м<sup>2</sup></span>",S=t.collection?t.collection.title:"---",q=t.brand?t.brand.title:"---",C=t.description||"---",b=t.images&&t.images.length>0?t.images:[{title:null}],w=document.querySelector("#modalProduct .pro-details-cart .add-cart");document.querySelector("#modalProduct .modal-body h2").innerText=r,document.querySelector("#modalProduct .modal-body .new-price").innerText=`${d} ₽`,document.querySelector("#modalProduct .modal-body .new-sku").innerText=a,document.querySelector("#modalProduct .modal-body .new-unit").innerHTML=h,document.querySelector("#modalProduct .modal-body .new-collection").innerText=S,document.querySelector("#modalProduct .modal-body .new-brand").innerText=q,document.querySelector("#modalProduct .modal-body .new-description").innerText=C,w.setAttribute("data-product-id",t.id),document.querySelector("#modalProduct .modal-body .swiper-container .swiper-wrapper").innerHTML=b.map(s=>`<div class="swiper-slide" style="border: none;"><img class="img-responsive m-auto" src="${s.title?`${o}/storage/images/${s.title}`:`${o}/assets/images/stock/stock-image.png`}" alt="${s.title?s.title:"Изображение по умолчанию"}"></div>`).join("")}).catch(t=>{console.error(t),document.querySelector("#modalProduct .modal-body h2").innerText="Ошибка загрузки данных"})})})});
