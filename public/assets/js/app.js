document.addEventListener("DOMContentLoaded",function(){g(),w(),L()});function g(){document.querySelectorAll(".add-cart").forEach(c=>{c.addEventListener("click",function(){var a;const e=this.dataset.productId,r=(a=this.closest(".pro-details-quality"))==null?void 0:a.querySelector(".cart-plus-minus-box"),i=r?parseInt(r.value):1;r&&(r.value=1),E(e,i)})}),document.querySelectorAll(".cart-plus-minus-box").forEach(c=>{c.closest(".table-content")&&c.addEventListener("change",function(){const e=this.closest("tr").dataset.productId;l(e,this.value)})}),document.querySelectorAll(".product-remove a").forEach(c=>{c.addEventListener("click",function(e){e.preventDefault();const r=this.closest("tr").dataset.productId;m(r)})})}function w(){document.querySelectorAll(".cart-plus-minus").forEach(n=>{const t=n.querySelector(".cart-plus-minus-box");if(!t)return;const c=document.createElement("div"),e=document.createElement("div");c.className="dec qtybutton",c.textContent="-",e.className="inc qtybutton",e.textContent="+",t.parentNode.insertBefore(c,t),t.parentNode.appendChild(e),c.addEventListener("click",()=>d(t,-1)),e.addEventListener("click",()=>d(t,1))})}function d(o,n){let t=parseInt(o.value);if(t=Math.max(1,t+n),o.value=t,o.closest(".table-content")){const c=o.closest("tr").dataset.productId;l(c,t)}}function E(o,n){fetch("/cart/add",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({product_id:o,quantity:n})}).then(t=>t.json()).then(t=>{f(t.message),p(t.cart_count),u()}).catch(t=>console.error("Ошибка:",t))}function l(o,n){fetch("/cart/update",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({product_id:o,quantity:n})}).then(t=>t.json()).then(t=>{y(t.total),x(o,n),u()}).catch(t=>console.error("Ошибка:",t))}function m(o){fetch("/cart/remove",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({product_id:o})}).then(n=>n.json()).then(n=>{const t=document.querySelector(`tr[data-product-id="${o}"]`);t&&t.remove(),y(n.total),p(n.cart_count),f(n.message),u(),window.location.pathname==="/cart"&&n.cart_count===0&&window.location.reload()}).catch(n=>console.error("Ошибка:",n))}function f(o){const n=document.createElement("div");n.className="cart-notification",n.textContent=o,document.body.appendChild(n),setTimeout(()=>{n.remove()},3e3)}function p(o){const n=document.querySelector(".header-action-num"),t=document.querySelectorAll(".header-action-btn-cart div, .header-action-btn-cart");n&&(n.textContent=o),t.forEach(c=>{let e=c.querySelector(".header-action-num");if(o>0){if(!e)if(e=document.createElement("span"),e.className="header-action-num",c.tagName.toLowerCase()==="a"){const r=c.querySelector(".pe-7s-cart");r&&r.after(e)}else c.appendChild(e);e.textContent=o.toString()}else e&&e.remove()})}function y(o){let n=o.toLocaleString("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).replace(",",".");const t=document.querySelector(".cart-total");t&&(t.textContent=`${n} ₽`)}function x(o,n){const t=document.querySelector(`tr[data-product-id="${o}"]`);if(t){const c=t.querySelector(".product-subtotal"),r=t.querySelector(".product-price-cart .amount").textContent.replace(/\s/g,""),i=parseFloat(r);if(c&&!isNaN(i)){let a=i*n;a=a.toLocaleString("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).replace(",","."),c.textContent=`${a} ₽`}}}function L(){const o=document.querySelector('a[href="#offcanvas-cart"]');o&&o.addEventListener("click",function(n){u()}),v()}function u(){fetch("/cart/offcanvas",{headers:{"X-Requested-With":"XMLHttpRequest"}}).then(o=>o.text()).then(o=>{const c=new DOMParser().parseFromString(o,"text/html").querySelector("#offcanvas-cart");if(c){const e=document.querySelector("#offcanvas-cart");e.innerHTML=c.innerHTML,v()}}).catch(o=>{console.error("Ошибка обновления корзины:",o)})}function v(){document.querySelectorAll("#offcanvas-cart .remove").forEach(t=>{t.replaceWith(t.cloneNode(!0));const c=document.querySelector(`#offcanvas-cart .remove[data-product-id="${t.dataset.productId}"]`);c&&c.addEventListener("click",function(e){e.preventDefault();const r=this.dataset.productId;m(r)})});const n=document.querySelector("#offcanvas-cart .offcanvas-close");n&&(n.replaceWith(n.cloneNode(!0)),document.querySelector("#offcanvas-cart .offcanvas-close").addEventListener("click",function(c){c.preventDefault(),document.body.classList.remove("offcanvas-open"),document.querySelector("#offcanvas-cart").classList.remove("offcanvas-open"),document.querySelector(".offcanvas-overlay").style.display="none",document.querySelector(".offcanvas-overlay").classList.remove("active")}))}document.addEventListener("DOMContentLoaded",function(){const o=window.location.origin;document.querySelectorAll(".quickview").forEach(t=>{t.addEventListener("click",function(){document.querySelector(".cart-plus-minus-box").value=1;const c=this.getAttribute("data-id");document.querySelector("#modalProduct .modal-body h2").innerText="Загрузка...",document.querySelector("#modalProduct .modal-body .new-price").innerText="",document.querySelector("#modalProduct .modal-body .swiper-container .swiper-wrapper").innerHTML="",fetch(`${o}/api/product/${c}`).then(e=>{if(!e.ok)throw new Error("Ошибка загрузки данных");return e.json()}).then(e=>{const r=e.category.title+" "+e.title||"---",a=(+e.price||"---").toLocaleString("ru-RU",{minimumFractionDigits:2,maximumFractionDigits:2}).replace(",","."),h=e.sku||"---",S=e.unit==="шт"?"<span>шт.</span>":"<span>м<sup>2</sup></span>",q=e.collection?e.collection.title:"---",C=e.brand?e.brand.title:"---",b=e.images&&e.images.length>0?e.images:[{title:null}],T=document.querySelector("#modalProduct .pro-details-cart .add-cart");document.querySelector("#modalProduct .modal-body h2").innerText=r,document.querySelector("#modalProduct .modal-body .new-price").innerText=`${a} ₽`,document.querySelector("#modalProduct .modal-body .new-sku").innerText=h,document.querySelector("#modalProduct .modal-body .new-unit").innerHTML=S,document.querySelector("#modalProduct .modal-body .new-collection").innerText=q,document.querySelector("#modalProduct .modal-body .new-brand").innerText=C,T.setAttribute("data-product-id",e.id),document.querySelector("#modalProduct .modal-body .swiper-container .swiper-wrapper").innerHTML=b.map(s=>`<div class="swiper-slide" style="border: none;"><img class="img-responsive m-auto" src="${s.title?`${o}/storage/images/${s.title}`:`${o}/assets/images/stock/stock-image.png`}" alt="${s.title?s.title:"Изображение по умолчанию"}"></div>`).join("")}).catch(e=>{console.error(e),document.querySelector("#modalProduct .modal-body h2").innerText="Ошибка загрузки данных"})})})});
