document.addEventListener("DOMContentLoaded",function(){T(),w(),L()});function T(){document.querySelectorAll(".add-cart").forEach(c=>{c.addEventListener("click",function(){var a;const n=this.dataset.productId,r=((a=this.closest(".pro-details-quality"))==null?void 0:a.querySelector(".cart-plus-minus-box"))||document.querySelector(".cart-plus-minus-box"),s=r?r.value:1;E(n,s)})}),document.querySelectorAll(".cart-plus-minus-box").forEach(c=>{c.closest(".table-content")&&c.addEventListener("change",function(){const n=this.closest("tr").dataset.productId;l(n,this.value)})}),document.querySelectorAll(".product-remove a").forEach(c=>{c.addEventListener("click",function(n){n.preventDefault();const r=this.closest("tr").dataset.productId;m(r)})})}function w(){document.querySelectorAll(".cart-plus-minus").forEach(e=>{const t=e.querySelector(".cart-plus-minus-box");if(!t)return;const c=document.createElement("div"),n=document.createElement("div");c.className="dec qtybutton",c.textContent="-",n.className="inc qtybutton",n.textContent="+",t.parentNode.insertBefore(c,t),t.parentNode.appendChild(n),c.addEventListener("click",()=>d(t,-1)),n.addEventListener("click",()=>d(t,1))})}function d(o,e){let t=parseInt(o.value);if(t=Math.max(1,t+e),o.value=t,o.closest(".table-content")){const c=o.closest("tr").dataset.productId;l(c,t)}}function E(o,e){fetch("/cart/add",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({product_id:o,quantity:e})}).then(t=>t.json()).then(t=>{p(t.message),f(t.cart_count),i()}).catch(t=>console.error("Ошибка:",t))}function l(o,e){fetch("/cart/update",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({product_id:o,quantity:e})}).then(t=>t.json()).then(t=>{y(t.total),x(o,e),i()}).catch(t=>console.error("Ошибка:",t))}function m(o){fetch("/cart/remove",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({product_id:o})}).then(e=>e.json()).then(e=>{const t=document.querySelector(`tr[data-product-id="${o}"]`);t&&t.remove(),y(e.total),f(e.cart_count),p(e.message),i(),window.location.pathname==="/cart"&&e.cart_count===0&&window.location.reload()}).catch(e=>console.error("Ошибка:",e))}function p(o){const e=document.createElement("div");e.className="cart-notification",e.textContent=o,document.body.appendChild(e),setTimeout(()=>{e.remove()},3e3)}function f(o){const e=document.querySelector(".product-subtotal"),t=document.querySelector(".header-action-btn-cart div");if(e&&(e.textContent=o),!t)return;let c=t.querySelector(".header-action-num");o>0?(c||(c=document.createElement("span"),c.className="header-action-num",t.appendChild(c)),c.textContent=o.toString()):c&&c.remove()}function y(o){const e=document.querySelector(".cart-total");e&&(e.textContent=`${o} ₽`)}function x(o,e){const t=document.querySelector(`tr[data-product-id="${o}"]`);if(t){const c=t.querySelector(".product-subtotal"),n=parseFloat(t.querySelector(".product-price-cart .amount").textContent);if(c&&!isNaN(n)){const r=n*e;c.textContent=`${r.toFixed(1)} ₽`}}}function L(){const o=document.querySelector('a[href="#offcanvas-cart"]');o&&o.addEventListener("click",function(e){i()})}function i(){fetch("/cart/offcanvas",{headers:{"X-Requested-With":"XMLHttpRequest"}}).then(o=>o.text()).then(o=>{const c=new DOMParser().parseFromString(o,"text/html").querySelector("#offcanvas-cart");if(c){const n=document.querySelector("#offcanvas-cart");n.innerHTML=c.innerHTML,g()}})}function g(){document.querySelectorAll("#offcanvas-cart .remove").forEach(t=>{t.addEventListener("click",function(c){c.preventDefault();const n=this.closest("li").dataset.productId;m(n)})});const e=document.querySelector("#offcanvas-cart .offcanvas-close");e&&e.addEventListener("click",function(t){t.preventDefault(),document.body.classList.remove("offcanvas-open"),document.querySelector("#offcanvas-cart").classList.remove("offcanvas-open"),document.querySelector(".offcanvas-overlay").style.display="none",document.querySelector(".offcanvas-overlay").classList.remove("active")})}document.addEventListener("DOMContentLoaded",function(){const o=window.location.origin;document.querySelectorAll(".quickview").forEach(t=>{t.addEventListener("click",function(){document.querySelector(".cart-plus-minus-box").value=1;const c=this.getAttribute("data-id");document.querySelector("#modalProduct .modal-body h2").innerText="Загрузка...",document.querySelector("#modalProduct .modal-body .new-price").innerText="",document.querySelector("#modalProduct .modal-body .swiper-container .swiper-wrapper").innerHTML="",fetch(`${o}/api/product/${c}`).then(n=>{if(!n.ok)throw new Error("Ошибка загрузки данных");return n.json()}).then(n=>{const r=n.title||"---",s=n.price||"---",a=n.sku||"---",v=n.unit==="шт"?"<span>шт.</span>":"<span>м<sup>2</sup></span>",h=n.collection?n.collection.title:"---",S=n.brand?n.brand.title:"---",q=n.description||"---",b=n.images&&n.images.length>0?n.images:[{title:null}],C=document.querySelector("#modalProduct .pro-details-cart .add-cart");document.querySelector("#modalProduct .modal-body h2").innerText=r,document.querySelector("#modalProduct .modal-body .new-price").innerText=`${s} ₽`,document.querySelector("#modalProduct .modal-body .new-sku").innerText=a,document.querySelector("#modalProduct .modal-body .new-unit").innerHTML=v,document.querySelector("#modalProduct .modal-body .new-collection").innerText=h,document.querySelector("#modalProduct .modal-body .new-brand").innerText=S,document.querySelector("#modalProduct .modal-body .new-description").innerText=q,C.setAttribute("data-product-id",n.id),document.querySelector("#modalProduct .modal-body .swiper-container .swiper-wrapper").innerHTML=b.map(u=>`<div class="swiper-slide" style="border: none;"><img class="img-responsive m-auto" src="${u.title?`${o}/storage/images/${u.title}`:`${o}/assets/images/stock/stock-image.png`}" alt="${u.title?u.title:"Изображение по умолчанию"}"></div>`).join("")}).catch(n=>{console.error(n),document.querySelector("#modalProduct .modal-body h2").innerText="Ошибка загрузки данных"})})})});
